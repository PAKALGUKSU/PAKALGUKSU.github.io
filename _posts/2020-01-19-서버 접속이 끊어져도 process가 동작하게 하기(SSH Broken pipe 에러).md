---
title: "서버 접속이 끊어져도 process가 동작하게 하기(SSH broken pipe 에러)"
categories:
    - Development
tags :
    - Development
toc: True
---
## 서버 접속이 끊어졌을 때 프로세스가 종료되는 현상
SSH로 접속한 원격 서버에서 터미널을 통해 원하는 프로세스를 실행시킨 이후, SSH 연결을 종료하면 프로세스가 멈추는 경우가 있다. 나는 이 이유를 몰랐을 때 다음과 같은 문제를 겪었다.

1. SSH로 접속해서 쉘에서 띄운 Node.js 서버가 SSH를 끊으면 다운됨
2. SSH로 접속해서 쉘에서 띄운 딥러닝 코드가 SSH를 끊으면 다운됨

특히, broken pipe 등의 에러메시지가 출력되어 있는 경우도 있었다.

## 이유
위 경우들을 보면 **SSH로 접속해서 쉘에서 띄운 프로세스** 라는 공통점이 있는다. 즉, 쉘이 종료되면 쉘이 관리하고 있는 프로세스도 종료되는 것이다. 따라서 SSH(Secure Shell) 연결을 끊으면(=시큐어 셸을 종료하면) 당연히 서버에서 수행하던 프로세스(=쉘이 관리하던 프로세스)도 종료되는 것이다.

'쉘이 관리하는 프로세스' 라는 개념이 헷갈릴 수 있는데, SSH가 아닌 TeamViewer 등의 원격 제어 프로그램으로 원격 서버에 접속한 경우를 생각하면 편하다. 팀뷰어로 서버에 접속하고, 크롬 아이콘을 클릭해 크롬을 실행한다면 해당 프로세스는 쉘과 관계없이 실행되므로(=쉘이 관리하지 않으므로) 팀뷰어 접속이 끊어져도 종료되지 않는다.

## 해결방법
이러한 문제를 해결하기 위해서는 쉘과 프로세스를 분리해주면 된다. 즉, 쉘 없이도 프로세스가 실행될 수 있게 하면 된다. 이를 위해 흔히 사용하는 도구는 ```Node.js```의 process manager [PM2](https://pm2.keymetrics.io/) 등 다양한 프로세스 매니저들이 있는데, 나는 [tmux](https://github.com/tmux/tmux/wiki)를 주로 사용하는 편이다. 종류는 다양하지만, 이러한 프로세스 매니저들은 공통적으로 쉘과 독립적으로 프로세스를 실행할 수 있게 해준다.

tmux는 언어에 종속적이지 않고(pm2는 node.js 프로세스를 관리해주지만, tmux는 터미널을 관리해준다), 내 노트북에 서버의 tmux 터미널 화면을 원할 때 바로 띄울 수 있다는 장점이 있다.

참고로, **쉘과 프로세스를 분리하는 것**이 핵심이었기 때문에 tmux를 사용하면 꼭 원격 서버가 아니라 로컬에서 작업할 때도 쉘이 꺼져도 프로세스를 유지하게 할 수 있다. 즉, tmux를 통해 프로세스를 실행하면 실수로 쉘을 종료하더라도 프로세스가 계속 실행된다.